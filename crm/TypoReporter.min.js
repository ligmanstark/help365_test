function disableScroll() {
    $('body').addClass('stop-scrolling');
}

function enableScroll() {
    $('body').removeClass('stop-scrolling');
}

function request(_this, e, url, data, callback = null) {
    var request = new XMLHttpRequest;
    request.onreadystatechange = function () {
        if (request.readyState == 4 && request.status == 200 && callback != null) {
            var response = JSON.parse(request.response);
            data = {
                'context': {
                    'baglist': [response.item.__id]
                }
            }
            callback(data);
        }
    };
    request.open("POST", url, !0), request.onload = function () {
        // request.status >= 200 && request.status < 400 ? this.closeDialog() : (e.isError = !0, e.isSending = !1, this.refresh())
        if (request.status >= 200 && request.status < 400) {
            $('.ReportTypo-popup').find('.ReportTypo-main').removeClass('active').addClass('hidden')
            $('.ReportTypo-popup').find('.ReportTypo-success').removeClass('hidden').addClass('active')
            $('.ReportTypo-popup').addClass('active')
            setTimeout(() => {
                this.closeDialog()
                $('.ReportTypo-popup').removeClass('active')
            }, 3000)
        } else {
            (e.isError = !0, e.isSending = !1, this.refresh())
        }
    }.bind(_this), request.onerror = function () {
        e.isError = !0, e.isSending = !1, _this.refresh()
    }.bind(_this), request.send(JSON.stringify(data));
}

!function (e, t) {
    "object" == typeof exports && "object" == typeof module ? module.exports = t() : "function" == typeof define && define.amd ? define("TypoReporter", [], t) : "object" == typeof exports ? exports.TypoReporter = t() : e.TypoReporter = t()
}(this, function () {
    return function (e) {
        function t(o) {
            if (n[o]) return n[o].exports;
            var r = n[o] = {i: o, l: !1, exports: {}};
            return e[o].call(r.exports, r, r.exports, t), r.l = !0, r.exports
        }

        var n = {};
        return t.m = e, t.c = n, t.i = function (e) {
            return e
        }, t.d = function (e, n, o) {
            t.o(e, n) || Object.defineProperty(e, n, {configurable: !1, enumerable: !0, get: o})
        }, t.n = function (e) {
            var n = e && e.__esModule ? function () {
                return e.default
            } : function () {
                return e
            };
            return t.d(n, "a", n), n
        }, t.o = function (e, t) {
            return Object.prototype.hasOwnProperty.call(e, t)
        }, t.p = "", t(t.s = 1)
    }([function (e, t, n) {
        "use strict";

        function o(e, t, n) {
            if ("string" != typeof e) throw new Error("tagName must be a string");
            var o = document.createElement(e);
            return t && "object" === ("undefined" == typeof t ? "undefined" : r(t)) && Object.keys(t).forEach(function (e) {
                /on[A-Z][a-z]/.test(e) ? o[e.toLowerCase()] = t[e] : o.setAttribute(e, t[e])
            }), "string" == typeof n ? o.innerHTML = n : n instanceof Array && n.forEach(function (e) {
                o.appendChild(e)
            }), o
        }

        Object.defineProperty(t, "__esModule", {value: !0});
        var r = "function" == typeof Symbol && "symbol" == typeof Symbol.iterator ? function (e) {
            return typeof e
        } : function (e) {
            return e && "function" == typeof Symbol && e.constructor === Symbol && e !== Symbol.prototype ? "symbol" : typeof e
        };
        t.default = o, e.exports = t.default
    }, function (e, t, n) {
        "use strict";

        function o(e) {
            return e && e.__esModule ? e : {default: e}
        }

        function r(e, t) {
            if (e = e || {}, !t) throw new Error('"rootNode" is not passed');
            if (!e.formId) throw new Error('"formId" option is not defined');
            if (e.snippetFieldName = e.snippetFieldName || "entry.13240190", e.urlFieldName = e.urlFieldName || "entry.238687347", e.commentFieldName = e.commentFieldName || "entry.1447231081", e.endpointUrl = e.endpointUrl || "https://cors-anywhere.herokuapp.com/https://docs.google.com/forms/d/e/" + e.formId + "/formResponse?embedded=true", e.offset = e.offset || 50, e.translations = e.translations || this.translations, e.locale = e.locale || "en", !e.translations[e.locale]) throw new Error("No translations defined for locale " + e.locale);
            this.i18n = e.translations[e.locale], this.props = e, this.node = t, this.state = {}, this.submit = this.submit.bind(this), this.handleCommentChange = this.handleCommentChange.bind(this), this.closeDialog = this.closeDialog.bind(this), document.addEventListener("keydown", function (e) {
                e.ctrlKey && 13 === e.which && window.getSelection().toString().length != 0 && this.showDialog(), 27 === e.which && this.closeDialog()
            }.bind(this)), this.refresh()
        }

        Object.defineProperty(t, "__esModule", {value: !0});
        var s = n(0), i = o(s);
        r.prototype.translations = {
            en: {
                header: "Report a mistake",
                messageLabel: "There is a mistake in the following text:",
                commentLabel: "Your comment",
                send: "Send",
                sending: "Sending",
                cancel: "Cancel",
                error: "Error! Something went wrong..."
            },
            ru: {
                header: "Сообщите об опечатке",
                messageLabel: "Текст, в котором допущена ошибка:",
                commentLabel: "Ваш комментарий",
                send: "Отправить",
                sending: "Идет отправка",
                cancel: "Отмена",
                error: "Ошибка! Что-то пошло не так..."
            }
        }, r.prototype.render = function () {
            var e = this.state, t = this.i18n;
            return e.isOpen && (0, i.default)
            ("div", {class: "ReportTypo"},
                [(0, i.default)("div", {class: "ReportTypo-popup"},
                    [(0, i.default)("button", {
                        class: "ReportTypo-close",
                        type: "button",
                        onClick: this.closeDialog
                    }, ''),
                        (0, i.default)("div", {class: "ReportTypo-main active"}, [
                            (0, i.default)("div", {class: "ReportTypo-header"}, t.header),
                            (0, i.default)("div", {class: "ReportTypo-label"}, t.messageLabel),
                            (0, i.default)("div", {class: "ReportTypo-message"}, e.snippet),
                            (0, i.default)("div", {class: "floating_label"},
                                [(0, i.default)("input", {
                                        class: "ReportTypo-comment form-control fill_listener",
                                        id: "form-comment",
                                        type: "text",
                                        onKeyup: this.handleCommentChange
                                    }, e.comment),
                                (0, i.default)("label", {for: "form-comment",}, t.commentLabel),]),
                            (0, i.default)("div", {class: "ReportTypo-label"}, ""),
                            (0, i.default)("div", {style: ""},
                                [(0, i.default)("button",
                                    {
                                        type: "button",
                                        class: "ReportTypo-submit",
                                        onClick: this.submit
                                    }, e.isSending ? t.sending : t.send),
                                    (0, i.default)("button", {
                                        type: "button",
                                        class: "ReportTypo-cancel",
                                        onClick: this.closeDialog
                                    }, t.cancel)
                                ]),
                        ]),
                        (0, i.default)("div", {class: "ReportTypo-success hidden"}, [
                            (0, i.default)("div", {class: "ReportTypo-success-image"}, ''),
                            (0, i.default)("p", null, "Ваш отзыв успешно отправлен!"),
                            (0, i.default)("span", null, "Спасибо за обратную связь."),
                        ]),
                        (0, i.default)("div", null, e.isError && t.error)
                    ]
                )])
        }, r.prototype.refresh = function () {
            var e = this.node;
            e.innerHTML = "";
            var t = this.render();
            t && e.appendChild(t)
        }, r.prototype.submit = function () {
            var e = this.state, t = this.props;
            e.isSending = !0, this.refresh();
            var n = new FormData;
            var data = {
                'context': {
                    'tema': 'Быстрое оповещение об опечатках',
                    'tip': [{
                        'code': 'ispravit_opechatki',
                        'name': 'Исправить опечатки'
                    }],
                    'lokal': [{
                        'code': getLocale().toUpperCase(),
                        'name': getLocale().toLowerCase()
                    }],
                    'produkt': [getProduct().id],
                    'ssylka_na_statyu': window.location.href,
                    'opisanie': e.comment,
                    'snippet': e.snippet
                },
            };
            n.append(t.snippetFieldName, e.snippet), n.append(t.commentFieldName, e.comment), n.append(t.urlFieldName, window.location);

            var _this = this;
            request(this, e, t.endpointUrl + 'create', data, function (data) {
                request(_this, e, t.endpointUrl + 'run', data);
            })
        }, r.prototype.getSnippet = function () {
            var e = this.props, t = document.getSelection(), n = t.toString();
            disableScroll();
            if (n) {
                var o = t.getRangeAt(0), r = document.createRange(), s = document.createRange();
                r.setStartBefore(o.startContainer.ownerDocument.body), r.setEnd(o.startContainer, o.startOffset), s.setStart(o.endContainer, o.endOffset), s.setEndAfter(o.endContainer.ownerDocument.body);
                var i = r.toString().substr(-e.offset), a = s.toString().substr(0, e.offset),
                    l = n, p = document.createElement("div");
                return p.innerHTML = l, p.innerText.replace(/\r?\n|\r/g, "").replace(/\s+/g, " ")
            }
        }, r.prototype.showDialog = function () {
            var e = this.state;
            e.snippet = this.getSnippet(), e.snippet && (e.isOpen = !0, this.refresh())
        }, r.prototype.closeDialog = function () {
            enableScroll();
            this.state = {}, this.refresh()
        }, r.prototype.handleCommentChange = function (e) {
            this.state.comment = e.target.value
        }, t.default = r, e.exports = t.default
    }])
});